
```insta-toc
---
title:
  name: ""
  level: 1
  center: false
exclude: ""
style:
  listType: dash
omit: []
levels:
  min: 1
  max: 6
---

# 

- 0 - Creación del sistema clasificador
- 1 - Preparamos librerías etc.
- 2 - Binarizamos el target para convertirlo en una etiqueta binaria
- 3 - Separar el conjunto de entrenamiento en dos: train y test
- 4 - Estandarizar los datos antes de aplicar PCA
- 5 - Aplicar PCA con 2 componentes
- 6 - Aplicar MaxAbsScaler a los PCA
- 7 -  Crear y entrenar el modelo SVC
- 8 - Barrido del intervalo donde tenemos los ejemplos
- 9 -  Estimar la etiqueta de cada punto del intervalo barrido
- 10 - Pintar el conjunto de entrenamiento  la curva que separa las clases
- 11 - Realizar predicciones en el conjunto de validación
- 12 - Calcular métricas de rendimiento
```
## 0 - Creación del sistema clasificador
- En este ejercicio vamos a usar el conjunto de datos `california_housing`, queremos estimar si los ingresos de esa zona serán superiores o inferiores a 3,5 con un SVM
- **Obtención de la etiqueta**: 
	- Si $median\_income >3.5 \rightarrow y=1$ 
	- Si $median\_income \leq 3.5 \rightarrow y=0$

## 1 - Preparamos librerías etc.
```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.preprocessing import MaxAbsScaler, StandardScaler
from sklearn.model_selection import train_test_split
from sklearn.decomposition import PCA
from sklearn.svm import SVC
from sklearn.metrics import accuracy_score, confusion_matrix

plt.rcParams['figure.figsize']=(4,4)
np.set_printoptions(precision=2)
pd.set_option("display.precision", 4)
seed = 1460

#%% ---- cargar data set
folder_name = 'sample_data/'
file_name = 'california_housing_train.csv'
trainSet = pd.read_csv(folder_name+file_name)
target = ['median_income']
train_target = trainSet[target]
trainSet.drop(target, axis=1, inplace=True)
features = trainSet.columns
```

## 2 - Binarizamos el target para convertirlo en una etiqueta binaria
```python
train_target = (train_target > 3.5)*1
```

## 3 - Separar el conjunto de entrenamiento en dos: train y test
```python
val_size = 0.2
X_train, X_val, Y_train, Y_val = train_test_split(trainSet, train_target, stratify=train_target, shuffle=True,random_state=seed)
```

## 4 - Estandarizar los datos antes de aplicar PCA
```python
scaler_std = StandardScaler().set_output(transform='pandas')
scaler_std.fit(X_train)
X_train_std = scaler_std.transform(X_train)
```

## 5 - Aplicar PCA con 2 componentes
```python
n_components = 2
pca = PCA(n_components=n_components).set_output(transform='pandas')
pca.fit(X_train_std)
X_train_pca = pca.transform(X_train_std)
print(f'Varianza explicada con {n_components} \ componentes  = {100*pca.explained_variance_ratio_.sum():0.1f}%')
```

## 6 - Aplicar MaxAbsScaler a los PCA
```python
scaler_max = MaxAbsScaler().set_output(transform='pandas')
scaler_max.fit(X_train_pca)
X_train_final = scaler_max.transform(X_train_pca)
```

## 7 -  Crear y entrenar el modelo SVC
```python
max_iter = 2**16
C_svc = 2**0
kernel = 'rbf'
parameter = 2**4
give_Prob = False
model = SVC(kernel=kernel, C=C_svc, gamma=parameter,
            max_iter=max_iter, probability=give_Prob)
model.fit(X_train_final, Y_train.values.ravel())
```

## 8 - Barrido del intervalo donde tenemos los ejemplos
```python
ns = 50
range0 = np.linspace(X_train_final.min()[0],
                     X_train_final.max()[0], ns)
range1 = np.linspace(X_train_final.min()[1],
                     X_train_final.max()[1], ns)
test0, test1 = np.meshgrid(range0, range1)
test0 = test0.reshape(ns*ns,1)
test1 = test1.reshape(ns*ns,1)
```

## 9 -  Estimar la etiqueta de cada punto del intervalo barrido
```python
y_pred = model.predict( np.concatenate([test0, test1], axis=1) )
y_pred = np.reshape(y_pred, [ns,ns])
if give_Prob:
    y_prob = model.predict_proba( np.concatenate([test0, test1], axis=1) )
    y_prob = np.reshape(y_prob[:,1], [ns,ns])
```

## 10 - Pintar el conjunto de entrenamiento  la curva que separa las clases 
```python
def make_scatterplot(X,Y):
    color_list = ['r' if y == 0 else 'b' for y in Y.values]
    X.plot.scatter(x='pca0', y='pca1', c=color_list, alpha=0.15)
    return

make_scatterplot(X_train_final, Y_train)
ax = plt.gca()
ax.contour(range0, range1, y_pred, cmap='jet', origin='image')
plt.title(f' C={C_svc:0.2f}, kernel = {kernel}, hparam={parameter:0.2f}')
plt.show()
```

## 11 - Realizar predicciones en el conjunto de validación
```python
X_val_std = scaler_std.transform(X_val)
X_val_pca = pca.transform(X_val_std)
X_val_final = scaler_max.transform(X_val_pca)
y_pred = model.predict(X_val_final)
```

## 12 - Calcular métricas de rendimiento
```python
accuracy = accuracy_score(Y_val, y_pred)
cf_mat = confusion_matrix(Y_val, y_pred)

print(f'accuracy = {accuracy:0.3f}\n')
print(f'Matriz de confusion = \n {pd.DataFrame(cf_mat)}')
```

